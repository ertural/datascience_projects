---
title: "Yelp - EDA"
author: "Ertuğrul Ural"
date: "16 05 2019"
output:github_document
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

## Load Libraries
```{r, message=FALSE}
#Load pacman package and p_load function installs missing packages and loads all the packages given as input  
if (!require("pacman")) install.packages("pacman")

pacman::p_load("tidyverse",   #data manipulation and graphs
               "lubridate",   #date manipulation
               "stringr",     #string manipulation
               "wordcloud",   #wordcloud
               "tidytext",    #tidy implementation of NLP methods
               "leaflet",     #maps
               "igraph" ,     #graphs
               "ggraph",      #graphs
               "tm",          #for general text mining functions
               "SnowballC",   #for stemming
               "data.table",  #for efficiency of Importing Large CSV files
               "textcat")     #for language detection
```

1. Introduction
2. Overview of Business and Reviews dataframes
3. Number of Cities in Yelp Dataset
4. Most Popular Categories
5. Distribution of stars given by the users
6. Most Popular Categories
7. Top 20 cities with the largest number of restaurants
8. Most popular five cuisines in top 5 cities
9. Map of the Restaurants in Toronto
10. Most Appreciated Restaurants in Toronto
  + 10.0 “Pai Northern Thai Kitchen”
  + 10.1 Wordcloud of the reviews of "Pai Northern Thai Kitchen"
  + 10.2 Sentiment Analysis - Postive and Not So Postive Words of “Pai Northern Thai Kitchen”
  + 10.3 Calculate Sentiment for the reviews
  + 10.4 Top 5 Negative Reviews
  + 10.5 Top 5 Positive Reviews
  + 10.6 Most Common Bigrams of “Pai Northern Thai Kitchen”
  + 10.7 Relationship among words
11. Highly criticized restaurants in Toronto
  + 11.0 "Toula Restaurant & Bar"
  + 11.1 Word Cloud of the reviews of "Toula Restaurant & Bar"
  + 11.2 Sentiment Analysis - Postive and Not So Postive Words of "Toula Restaurant & Bar"
  + 11.3 Calculate Sentiment for the reviews
  + 11.4 Top 5 Negative Reviews of "Toula Restaurant & Bar"
  + 11.5 Top 5 Positive Reviews "Toula Restaurant & Bar"
  + 11.6 Most Common Bigrams of “Toula Restaurant & Bar”
  + 11.7 Relationship among words in "Toula Restaurant & Bar"
12. Proportion of closed restaurants types in Toronto
  + 12.1 The most negative comments among the closed restaurants
  + 12.2 Locations of the Open/Closed Restaurants in Toronto Map
  + 12.3 An interactive map of restaurants in Toronto with their average ratings
  + 12.4 The reviews given by customer for closed restaurants in Toronto related to food, service, ambience and staff 
  + 12.5 Word Cloud of the reviews of Watermark Irish Pub
  + 12.6 Sentiment Analysis - Postive and Not So Postive Words of "Watermark Irish Pub"
  + 12.7 Calculate Sentiment for the reviews of "Watermark Irish Pub"
  + 12.8 Top 5 Negative Reviews of "Watermark Irish Pub" 

## Load Data
```{r, message=FALSE}
business <- fread("~/yelp_business.csv", header = T, sep = ',')
review <- fread("~/yelp_review.csv", header = T, sep = ',')
```

#### The Yelp dataset is downloaded from https://www.yelp.com/dataset/challenge. In total, there are 5,261,668 user reviews, information on 174,567 business. we will focus on two tables which are business and review datasets. 

#### Attributes of business table are as following:

* business_id: ID of the business
* name: name of the business
* neighborhood: neighborhood of the business
* address: address of the business
* city: city of the business
* state: state of the business
* postal_code: postal code of the business
* latitude: latitude of the business
* longitude: longitude of the business
* stars: average rating of the business
* review_count: number of reviews received
* is_open: 1 if the business is open, 0 otherwise
* categories: multiple categories of the business

#### Attribues of review table are as following:

* review_id: ID of the review
* user_id: ID of the user
* business_id: ID of the business
* stars: ratings of the business
* date: review date
* text: review from the user
* useful: number of users who vote a review as usefull
* funny: number of users who vote a review as funny
* cool: number of users who vote a review as cool

## Overview of Business and Reviews dataframes
```{r, results="hide"}
head(business)
str(business)
glimpse(business)
summary(business)

head(review)
str(review)
glimpse(review)
summary(review)
```

## Number of Cities in Yelp Dataset

Las Vegas, Phoenix and Toronto seem to be most favorite cities in Yelp dataset.

```{r}
business$city=business$city %>% 
  as.factor

business$city%>%
  summary
```

## Most Popular Categories

The most popular categories of business are plotted in the bar plot

```{r, echo=FALSE}
categories = str_split(business$categories,";")
categories = as.data.frame(unlist(categories))
colnames(categories) = c("Name")

categories %>%
  group_by(Name) %>%
  summarise(Count = n()) %>%
  arrange(desc(Count)) %>%
  ungroup() %>%
  mutate(Name = reorder(Name,Count)) %>%
  head(20) %>%
  ggplot(aes(x = Name,y = Count)) +
  geom_bar(stat='identity',colour="White", fill="#00CED1") +
  geom_text(aes(x = Name, y = 1, label = paste0("(",Count,")",sep="")),
            hjust=0, vjust=.5, size = 4, colour = 'white',
            fontface = 'bold') +
  labs(x = 'Name of Category', y = 'Count', 
       title = 'Most Popular 20 Categories in Yelp') +
  coord_flip() + 
  theme_bw()
```

### I am only interested in restaurants for my further analysis. So let's remove all other businesses.

```{r}
business <- business %>%
  mutate(rest = ifelse(grepl('Restaurants',categories), 1, 0)) %>%
  filter(rest == 1)
```

### Let's look at the distribution of stars given by the users.

The distribution of ratings is considerably skewed, there are a lot more 4 and 5 star ratings than 1,2 and 3. we could say that people seem to review things they like. In general, people seem to be more likely to write a review for a positive experience than a negative one.

```{r, echo=FALSE}
ggplot(review, aes(x=stars))+
  geom_bar(stat="bin", bins= 9, fill="#00CED1") + 
  geom_text(stat='count', aes(label=..count..), vjust=1.6, color="white") +
  ggtitle("Star Counts") +
  xlab("Stars") + ylab("Count") +
  theme_minimal()
```

### Top 20 cities with the largest number of restaurants

We show the Top 20 cities which has the most number of restaurants mentioned in Yelp. Toronto, Las Vegas and Phoenix.

```{r, echo=FALSE}
business %>%
  group_by(city) %>%
  summarise(Count = n()) %>%
  arrange(desc(Count)) %>%
  ungroup() %>%
  mutate(City = reorder(city,Count)) %>%
  head(20) %>%
  ggplot(aes(x = City,y = Count)) +
  geom_bar(stat='identity',colour="white", fill = "#00CED1") +
  geom_text(aes(x = City, y = 1, label = paste0("(",round(Count/10^3)," K )",sep="")),
            hjust=0, vjust=.5, size = 4, colour = 'white', fontface = 'bold') +
  labs(x = 'City', y = 'Count of Reviews', 
       title = 'Most Popular 20 Cities in Yelp') +
  coord_flip() + 
  theme_bw()
```

### Most popular five cuisines in top 5 cities

We can see that the American cuisine is most popular in top 5 cities. But Fast food, Mexican and sandwiches have won the race in some places. Asian cuisines like Chinese and Japanese did make it to the top 5 only in Toronto.

```{r, echo=FALSE}
business$city=business$city %>% 
  as.factor

business$city%>%
  summary

# Filters the data so that we analyse only the restaurants from top 10 cities (Based on count)
top_5_cities <- c("Toronto", "Las Vegas", "Phoenix", "Charlotte", "Scottsdale")
business_5_cities <- business %>% filter(city %in% top_5_cities)

# Selected list of cuisines
cuisine_list <- c( "American (Traditional)", "American (New)", "Sandwiches", "Fast Food", "Mexican", "Pizza", "Italian", "Chinese", "Ice Cream & Frozen Yogurt", "Bakeries", "Desserts", "Seafood", "Sushi Bars", "Juice Bars & Smoothies", "Mediterranean", "Steakhouses", "Burgers", "Salad", "Barbeque", "Cocktail Bars", "Thai", "Buffets", "Hot Dogs", "Asian", "Japanese", "American", "Indian")

top_cusine_plot <- business_5_cities %>% 
                   # Only city and categories are needed for this analysis
                   dplyr::select(city , categories) %>%
                   # categories are seperated by ; in teh variable
                   transform(categories = strsplit(categories, ";")) %>%
                   # A single row is created for each category from the list
                   unnest(categories) %>%
                   # Only categories in the cuisine_list is considered
                   filter(categories %in% cuisine_list)  %>%  
                    dplyr::group_by(categories,city) %>%
                    # Count is calculated a combination of city and category
                    tally() %>% 
                    # Top 5 categories for a city is filtered 
                    dplyr::group_by(city) %>% 
                    top_n(n = 5) %>% 
                    # To plot uniformly, ranks are given. Maximum count is given the rank 1
                    mutate( count_rank = rank(-n)) %>% 
                    # Bar chart for each city is shown
                    ggplot(aes(x = count_rank, y = n))+ 
                    geom_bar(stat = "identity", fill = "#87cefa") + 
                    facet_wrap(~city, nrow = 2, scales = "free") + 
                    coord_flip() + 
                    # 1 should come on the top
                    scale_x_reverse() +
                    # Name of the cuisine is displayed inside the bars
                    geom_text(aes(label = categories), size = 2,hjust="inward") 

top_cusine_plot
```

### Map of the Restaurants in Toronto

Since in Yelp dataset the largest number of restaurants are in Toronto,that's why I wanted to continue analysis with Toronto.

```{r, echo=FALSE}
Toronto = business %>% filter(city == "Toronto")

center_lon = median(Toronto$longitude,na.rm = TRUE)
center_lat = median(Toronto$latitude,na.rm = TRUE)

leaflet(Toronto) %>% addProviderTiles("Esri.NatGeoWorldMap") %>%
  addCircles(lng = ~longitude, lat = ~latitude,radius = ~sqrt(review_count))  %>%
  
# controls
setView(lng=center_lon, lat=center_lat,zoom = 10)
```

### Most Appreciated Restaurants in Toronto

```{r}
BestReviews = review %>%
  filter(stars == 5) %>%
  group_by(business_id) %>%
  summarise(Count = n()) %>%
  arrange(desc(Count)) %>%
  ungroup() %>%
  mutate(BusinessID = reorder(business_id,Count))

BestReviews = inner_join(BestReviews, business, by = "business_id")

BestReviews_Toronto <- BestReviews %>%
  filter(city == "Toronto") %>%
  head(10)

BestReviews_Toronto %>%
  mutate(name = reorder(name,Count)) %>%
  ggplot(aes(x = name,y = Count)) +
  geom_bar(stat='identity',colour="white", fill = "#00CED1") +
  geom_text(aes(x = name, y = 1, label = paste0("(",Count,")",sep="")),
            hjust=0, vjust=.5, size = 3, colour = 'white',
            fontface = 'bold') +
  labs(x = 'Name of the Restaurants', 
       y = 'Count', 
       title = 'Most Appreciated Restaurants in Toronto') +
  coord_flip() +
  theme_bw()
```

### Wordcloud of the reviews of Pai Northern Thai Kitchen

```{r}

createWordCloud = function(train)
{
  train %>%
  unnest_tokens(word, text) %>%
  filter(!word %in% stop_words$word) %>%
  count(word,sort = TRUE) %>%
  ungroup()  %>%
  head(50) %>%
  
  with(wordcloud(word, n, max.words = 50,colors=brewer.pal(8, "Dark2")))
}

#Pai Northern Thai Kitchen
createWordCloud(review %>%
  filter(business_id == "r_BrIgzYcwo1NAuG9dLbpg"))

```

## Sentiment Analysis - Postive and Not So Postive Words of “Pai Northern Thai Kitchen”

```{r}
positiveWordsBarGraph <- function(SC) {
  contributions <- SC %>%
    unnest_tokens(word, text) %>%
    count(word,sort = TRUE) %>%
    ungroup() %>%
    
    inner_join(get_sentiments("afinn"), by = "word") %>%
    group_by(word) %>%
    summarize(occurences = n(),
              contribution = sum(score))
  
  contributions %>%
    top_n(20, abs(contribution)) %>%
    mutate(word = reorder(word, contribution)) %>%
    head(20) %>%
    ggplot(aes(word, contribution, fill = contribution > 0)) +
    geom_col(show.legend = FALSE) +
    coord_flip() + theme_bw()
}

positiveWordsBarGraph(review %>%
                        filter(business_id == "r_BrIgzYcwo1NAuG9dLbpg"))
```

### Calculate Sentiment for the reviews of Pai Northern Thai Kitchen

```{r}
Pai_Northern_Thai_reviews = review %>%
  filter(business_id == "r_BrIgzYcwo1NAuG9dLbpg")

calculate_sentiment <- function(review_text)
{
  sentiment_lines  =  review_text %>%
                  filter(textcat(text) == "english") %>%  # considering only English text
                  unnest_tokens(word, text) %>%
                  inner_join(get_sentiments("afinn"), by = "word") %>%
                  group_by(review_id) %>%
                  summarize(sentiment = mean(score),words = n()) %>%
                  ungroup() %>%
                  filter(words >= 5) 

  return(sentiment_lines)
  
}

sentiment_lines = calculate_sentiment(Pai_Northern_Thai_reviews)

head(sentiment_lines)
```

### Let's examine the top 5 most negative reviews.

Slow service, overpriced, uncomfortable chairs, the atmosphere is incredibly dark, crowded and noisy

```{r}
display_neg_sentiments <- function(sentiment_lines,review_text)
{
  neg_sentiment_lines = sentiment_lines %>%
  arrange(desc(sentiment))  %>%
  top_n(-5, sentiment) %>%
  inner_join(review_text, by = "review_id") %>%
  select(date,sentiment,text) 
  
head(neg_sentiment_lines$text)  

}

display_neg_sentiments(sentiment_lines,Pai_Northern_Thai_reviews)
```

### Let's examine the top 5 most positive reviews.

Very authentic Thai food, hospitable service, very welcoming and relaxing atmosphere, incredibly helpful staff  

```{r}
display_pos_sentiments <- function(sentiment_lines,review_text)
{
  pos_sentiment_lines = sentiment_lines %>%
  arrange(desc(sentiment))  %>%
  top_n(5, sentiment) %>%
  inner_join(review_text, by = "review_id") %>%
  select(date,sentiment,text) 
  
head(pos_sentiment_lines$text)  

}

display_pos_sentiments(sentiment_lines,Pai_Northern_Thai_reviews)
```

### Most Common Bigrams of “Pai Northern Thai Kitchen”

```{r}
count_bigrams <- function(dataset) {
  dataset %>%
    unnest_tokens(bigram, text, token = "ngrams", n = 2) %>%
    separate(bigram, c("word1", "word2"), sep = " ") %>%
    filter(!word1 %in% stop_words$word,
           !word2 %in% stop_words$word) %>%
    count(word1, word2, sort = TRUE)
}

visualize_bigrams <- function(bigrams) {
  set.seed(13)
  a <- grid::arrow(type = "closed", length = unit(.15, "inches"))
  
  bigrams %>%
    graph_from_data_frame() %>%
    ggraph(layout = "fr") +
    geom_edge_link(aes(edge_alpha = n), show.legend = FALSE, arrow = a) +
    geom_node_point(color = "lightblue", size = 5) +
    geom_node_text(aes(label = name), vjust = 1, hjust = 1) +
    theme_void()
  
}

visualize_bigrams_individual <- function(bigrams) {
  set.seed(2016)
  a <- grid::arrow(type = "closed", length = unit(.15, "inches"))
  
  bigrams %>%
    graph_from_data_frame() %>%
    ggraph(layout = "fr") +
    geom_edge_link(aes(edge_alpha = n), show.legend = FALSE, arrow = a,end_cap = circle(.07, 'inches')) +
    geom_node_point(color = "lightblue", size = 5) +
    geom_node_text(aes(label = name), vjust = 1, hjust = 1) +
    theme_void()
}

review %>%
  filter(business_id == "r_BrIgzYcwo1NAuG9dLbpg") %>%
  unnest_tokens(bigram, text, token = "ngrams", n = 2) %>%
  select(bigram,review_id) %>%
  head(10)

```

### We can explore the different relationship among the various words in Pai_Northern_Thai reviews here through a network graph

wait ==> time, recommend <== highly,  

```{r}
bigrams_Pai_Northern_Thai <- review %>%
  filter(business_id == "r_BrIgzYcwo1NAuG9dLbpg") %>%
  count_bigrams()

bigrams_Pai_Northern_Thai %>%
  filter(n > 25) %>%
  visualize_bigrams()
```

### Highly criticized restaurants in Toronto

```{r}
WorstReviews <- review %>%
  filter(stars == 1) %>%
  group_by(business_id) %>%
  summarise(Count = n()) %>%
  arrange(desc(Count)) %>%
  ungroup() %>%
  mutate(BusinessID = reorder(business_id,Count))

WorstReviews = inner_join(WorstReviews, business, by = "business_id")

WorstReviews_Toronto <- WorstReviews %>%
  filter(city == "Toronto") %>%
  head(10)

WorstReviews_Toronto %>%
  mutate(name = reorder(name,Count)) %>%
  ggplot(aes(x = name,y = Count)) +
  geom_bar(stat='identity',colour="white", fill = "#00CED1") +
  geom_text(aes(x = name, y = 1, label = paste0("(",Count,")",sep="")),
            hjust=0, vjust=.5, size = 3, colour = 'white',
            fontface = 'bold') +
  labs(x = 'Name of the Restaurants', 
       y = 'Count', 
       title = 'Highly criticized restaurants in Toronto') +
  coord_flip() +
  theme_bw()
```

### Wordcloud for the reviews of “Toula Restaurant & Bar”

```{r}

#Toula Restaurant & Bar
createWordCloud(review %>%
  filter(business_id == "jluEI1ZDQDeJlbl-M3YH3Q"))

```

### Sentiment Analysis - Postive and Not So Postive Words of “Toula Restaurant & Bar”

```{r}
positiveWordsBarGraph <- function(SC) {
  contributions <- SC %>%
    unnest_tokens(word, text) %>%
    count(word,sort = TRUE) %>%
    ungroup() %>%
    
    inner_join(get_sentiments("afinn"), by = "word") %>%
    group_by(word) %>%
    summarize(occurences = n(),
              contribution = sum(score))
  
  contributions %>%
    top_n(20, abs(contribution)) %>%
    mutate(word = reorder(word, contribution)) %>%
    head(20) %>%
    ggplot(aes(word, contribution, fill = contribution > 0)) +
    geom_col(show.legend = FALSE) +
    coord_flip() + theme_bw()
}

positiveWordsBarGraph(review %>%
                        filter(business_id == "jluEI1ZDQDeJlbl-M3YH3Q"))
```

### Calculate Sentiment for the reviews of Toula Restaurant & Bar

```{r}
Toula_Restaurant_reviews = review %>%
  filter(business_id == "jluEI1ZDQDeJlbl-M3YH3Q")

calculate_sentiment <- function(review_text)
{
  sentiment_lines  =  review_text %>%
                  filter(textcat(text) == "english") %>%  # considering only English text
                  unnest_tokens(word, text) %>%
                  inner_join(get_sentiments("afinn"), by = "word") %>%
                  group_by(review_id) %>%
                  summarize(sentiment = mean(score),words = n()) %>%
                  ungroup() %>%
                  filter(words >= 5) 

  return(sentiment_lines)
  
}

sentiment_lines = calculate_sentiment(Toula_Restaurant_reviews)

head(sentiment_lines)
```

### Let's examine the top 5 most negative reviews.

Unfriendly staff, expensive and one of the worst meals, Do no waste ur money on this place, aggressive owner and staff, bad service

```{r}
display_neg_sentiments(sentiment_lines,Toula_Restaurant_reviews)
```

### Let's examine the top 5 most positive reviews.

The only pro was the amazing view!, fantastic view, warm service, romantic ambience, pretty good prices, kind and pleasent server.

```{r}
display_pos_sentiments(sentiment_lines,Toula_Restaurant_reviews)
```

### We can explore the different relationship among the various words in Toula Restaurant & Bar reviews here through a network graph

Service <== bad ==> reviews, amazing ==> view
```{r}
bigrams_Toula_Restaurant <- review %>%
  filter(business_id == "jluEI1ZDQDeJlbl-M3YH3Q") %>%
  count_bigrams()

bigrams_Toula_Restaurant %>%
  filter(n > 5) %>%
  visualize_bigrams()
```

### Proportion of closed restaurants types in Toronto

There seems to be a significant difference between the number of reviews made and the rating given between open and closed restaurants.

```{r}

business %>%
  filter(city == "Toronto") %>%
  group_by(is_open)%>%
  summarise(n=n(), AvgReview = mean(review_count, na.rm = T), AvgStar = mean(stars, na.rm = T)) %>% 
  filter(n>50)%>%
  arrange(desc(n)) %>% 
  head(20)

business %>%
  filter(city == "Toronto") %>%
  unnest(categories) %>%
  group_by(categories)%>%
  summarise(n=n(), close_prop=sum(is_open==0)/n, open_prop=sum(is_open==1)/n, AvgStar = mean(stars, na.rm = T)) %>% 
  filter(n>50)%>%
  arrange(desc(close_prop),desc(n)) %>% 
  head(20)

```

### The most negative comments among the closed restaurants

```{r}
ClosedReviews <- review %>%
  filter(stars < 3) %>%
  group_by(business_id) %>%
  summarise(Count = n()) %>%
  arrange(desc(Count)) %>%
  ungroup() %>%
  mutate(BusinessID = reorder(business_id,Count))

ClosedReviews = inner_join(ClosedReviews, business, by = "business_id")

ClosedReviews_Toronto <- ClosedReviews %>%
  filter(city == "Toronto", is_open == 0) %>%
  head(10)

ClosedReviews_Toronto %>%
  mutate(name = reorder(name,Count)) %>%
  ggplot(aes(x = name,y = Count)) +
  geom_bar(stat='identity',colour="white", fill = "#00CED1") +
  geom_text(aes(x = name, y = 1, label = paste0("(",Count,")",sep="")),
            hjust=0, vjust=.5, size = 3, colour = 'white',
            fontface = 'bold') +
  labs(x = 'Name of the Restaurants', 
       y = 'Count', 
       title = 'Closed restaurants in Toronto') +
  coord_flip() +
  theme_bw()
```

### Locations of the Open/Closed Restaurants in Map

```{r, echo=FALSE}
### Map of the Restaurants in Toronto

Toronto <- business %>% filter(city == "Toronto")

center_lon = median(Toronto$longitude,na.rm = TRUE)
center_lat = median(Toronto$latitude,na.rm = TRUE)

pal <- colorFactor(
  palette = 'Dark2',
  domain = Toronto$is_open)

leaflet(Toronto) %>% addProviderTiles("Esri.NatGeoWorldMap") %>%
  addCircles(lng = ~longitude, lat = ~latitude, radius = ~sqrt(review_count), color = ~pal(is_open))  %>%
  addLegend("bottomright", pal = pal, values = ~is_open, title = "Open==1",) %>%
  #addCircleMarkers(color = Toronto$is_open) %>% 
  
# controls
setView(lng=center_lon, lat=center_lat,zoom = 10)


```

### An interactive map of restaurants in Toronto with their average ratings indicated by color.

```{r, echo = FALSE}
pal2 <- colorBin(c("Red", "Blue", "Green"), Toronto$stars, 3, pretty = FALSE)
map2 <- leaflet(Toronto) %>% addProviderTiles("Esri.NatGeoWorldMap") %>% 
  addCircleMarkers(lng = ~longitude, lat = ~latitude, weight = 0, radius=5, fillOpacity = 0.7 , color = ~pal2(stars), popup = ~name) %>% 
  addLegend("bottomright", pal=pal2, values=stars, title = "Restaurants and their Average Ratings", labels=~pal2(stars),
            labFormat = labelFormat(prefix = ""), opacity = 0.7) 
map2
```

### For closed restaurants in Toronto the reviews given by customer related to food, service and staff 

There are negative reviews about the service for closed restaurants in Toronto. Although there were positive comments about the staff, the slow and poor service could have caused these businesses to close.
```{r}

review2  <- review %>% 
           filter(business_id %in% business$business_id ) 

useful <-     review2 %>% 
              left_join(business, by = "business_id") %>% 
              # Filters reviews for Toronto
              filter(city == 'Toronto', is_open == 0) %>%
              # Only reviews that atleast 2 people found as useful is taken
              filter(useful > 1)

# All text is converted to lower case
useful$text <- tolower(useful$text)
# Stop words and repeating words like Las vegas, http, www.yelp.com are removed
useful$text <- removeWords(useful$text ,c(stopwords("en")))
useful$text <- removeNumbers(useful$text)

# Bigrams are created with words in review text
bigrams <- useful %>% 
           unnest_tokens(bigram, text, token = "ngrams", n = 2)

# List of words that are of significance
analysis_word <- c("food", "service", "staff", "ambience")

# Creates data for network analysis graph
bg_grapgh <- bigrams %>%
             # Words from bigram are seperated
             separate(bigram, c("word1", "word2"), sep = " ")  %>% 
             # Count for each combination of words are calculated
             group_by(word1, word2) %>% 
             summarise( n = n()) %>%
             # Only the combination with significant words in the beginning and min freq of 50 are taken
             filter( word1 %in% analysis_word & n > 50) %>%
             # Creates data for network graph
             graph_from_data_frame()
             
arrow_format <- grid::arrow(type = "closed", length = unit(.1, "inches"))

## Visual representation of connection of pair of words
ggraph(bg_grapgh, layout = "fr") +
  # Connection between words are represented by arrows
  geom_edge_link(aes(edge_alpha = n), 
                 show.legend = TRUE,
                 arrow = arrow_format, 
                 end_cap = circle(.1, 'inches')) +
  # Nodes for words
  geom_node_point(color = 'light blue', 
                  size = 7) +
  # Text is displayed
  geom_node_text(aes(label = name), 
                 vjust = 1, 
                 hjust = 1,
                 repel = TRUE) +
  theme_void()

```

### Wordcloud for the reviews of “Watermark Irish Pub”

```{r}

#Toula Restaurant & Bar
createWordCloud(review %>%
  filter(business_id == "JgaQFKxW-Bnfc7r5EJZhSQ"))

```

### Sentiment Analysis - Postive and Not So Postive Words of “Watermark Irish Pub”

```{r}
positiveWordsBarGraph <- function(SC) {
  contributions <- SC %>%
    unnest_tokens(word, text) %>%
    count(word,sort = TRUE) %>%
    ungroup() %>%
    
    inner_join(get_sentiments("afinn"), by = "word") %>%
    group_by(word) %>%
    summarize(occurences = n(),
              contribution = sum(score))
  
  contributions %>%
    top_n(20, abs(contribution)) %>%
    mutate(word = reorder(word, contribution)) %>%
    head(20) %>%
    ggplot(aes(word, contribution, fill = contribution > 0)) +
    geom_col(show.legend = FALSE) +
    coord_flip() + theme_bw()
}

positiveWordsBarGraph(review %>%
                        filter(business_id == "JgaQFKxW-Bnfc7r5EJZhSQ"))
```

### Let's examine the top 5 most negative reviews.

service was subpar, The hostesses at the patio were incredibly rude, The service was horrendous, Worst veggie burger, Terrible service

```{r}
Watermark_Irish_Pub = review %>%
  filter(business_id == "JgaQFKxW-Bnfc7r5EJZhSQ")

sentiment_lines = calculate_sentiment(Watermark_Irish_Pub)
display_neg_sentiments(sentiment_lines ,Watermark_Irish_Pub)
```

### Ineteresting findings
* American cuisine is most popular in top 5 cities. Sandwiches and fast food are the next best options. Asian cuisines like Indian and Chinese are good options in Toronto.

* Restaurants are mostly in downtowns. When you move further away from the city, number restuarants for which we have information reduces.

* Lot of words are used in common to describe food and service. thrilled, superb and desperate, deceiving are used comparitively in same frequency to describe services of restaurants in Toronto. Staff and ambience are not descibed using frequent terms in reviews as compared to food and service.

* The distinguishing factor between 4 and 5 could be the taste/quality of food. Top rated restaurant has classy ambience that distinguishes them from 4. Low rated restaurants have unconfortable, poor or horrible ambience. When we move down the rating, the negative words increases across the attributes. The staff at low rated restaurants are described as annoying, stingy, confused and dumb. The service sucks and is horrible and awful. Food becomes dissappointing and horrible.

* Reviews for restaurants with low rating of 1 and 2 predominantly express anger, sadness, fear and disgust. Medium rating of 3 shows a large amount of anticipation in their reviews. Though customers express percentage of trust in reviews for restaurants with rating of 4 and 5, reviews shows more joy in customers at 5 rated restaurants.


### Further steps.

* Create a machine learning model that will identify if the restaurant is open or closed

* Predict the rating that customer might give to a restaurant by analysing the review given by him/her.




